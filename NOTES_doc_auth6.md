# Access token and jwks

<!-- 
Briefly explain the need to validate access token.
Briefly explian what is JWKS.

Describe a little bit that the following methods are available in all flow builders, namely:

* âœ… **Authorization Code Flow**
* âœ… **Client Credentials**
* âœ… **Device Authorization Flow**

in [`@kaapi/oauth2-auth-design`](https://www.npmjs.com/package/@kaapi/oauth2-auth-design) package.

even though examples will only be made with some builders, it is the same for the others.

-->

---

## JWKS endpoint

Choose an endpoint to return public keys with `jwksRoute`.

Example with Authorization Code Flow builder:

```ts
import { OAuth2AuthorizationCodeBuilder } from '@kaapi/oauth2-auth-design';

OAuth2AuthorizationCodeBuilder
  .create()
  .jwksRoute(route => route
    .setPath('/.well-known/jwks.json') // path, default '/oauth2/keys'
  )
  // configure additional settings
```

You can overwrite the controller for jwks endpoint:

```ts
import { OAuth2AuthorizationCodeBuilder } from '@kaapi/oauth2-auth-design';

OAuth2AuthorizationCodeBuilder
  .create()
  .jwksRoute(route => route
    .setPath('/.well-known/jwks.json') // path, default '/oauth2/keys'
    .validate(({ jwks }, request, h) => {
      return jwks; // 'jwks' contains the public keys generated by the library '@kaapi/oauth2-auth-design'
    })
  )
  // configure additional settings
```

---

## JWKS key store

By default, the library uses an in-memory store good for tests and dev but not for production.
The in-memory store can be explicitly set with `setJwksKeyStore` and `createInMemoryKeyStore`.

Example with Authorization Code Flow builder:

```ts
import { OAuth2AuthorizationCodeBuilder, createInMemoryKeyStore } from '@kaapi/oauth2-auth-design';

OAuth2AuthorizationCodeBuilder
  .create()
  .setJwksKeyStore(createInMemoryKeyStore());
```

The Jwks key store must implement the interface `JwksKeyStore`. This store is responsible for:

- Retrieving the active private key
- Accessing public keys
- Persisting new key pairs

```ts
interface JwksKeyStore {
    /**
     * Stores the current active private key and its corresponding public key.
     * The public key will be kept for the duration of the TTL for JWKS purposes.
     */
    storeKeyPair(kid: string, privateKey: object, publicKey: object, ttl: number): void | Promise<void>
    /**
     * Retrieves the current private key used for signing.
     */
    getPrivateKey(): Promise<object | undefined>
    /**
     * Retrieves all valid public keys that have not expired.
     * These are used for exposing in JWKS.
     */
    getPublicKeys(): Promise<object[]>
}
```

---

## Key rotation

Configure key rotation with `setJwksRotatorOptions`. The method accepts:

- `intervalMs`: rotation interval in milliseconds
- `timestampStore`: an implementation of `JwksRotationTimestampStore` to track the last rotation

```ts
interface JwksRotationTimestampStore {
  getLastRotationTimestamp(): Promise<number>
  setLastRotationTimestamp(rotationTimestamp: number): Promise<void>
}
```

Example with in-memory store:

```ts
import { OAuth2AuthorizationCodeBuilder, createInMemoryKeyStore } from '@kaapi/oauth2-auth-design';

const authCodeFlow = OAuth2AuthorizationCodeBuilder
  .create()
  .setJwksRotatorOptions({
    intervalMs: 7.862e+9, // 91 days
    timestampStore: createInMemoryKeyStore()
  })
  .build();

// Initial rotation check
authCodeFlow.checkAndRotateKeys().catch(console.error);

// Periodic rotation check (every hour)
setInterval(() => {
  authCodeFlow.checkAndRotateKeys().catch(console.error);
}, 3600 * 1000);
```

The `checkAndRotateKeys` method evaluates whether a new key pair should be generated and updates the key store accordingly.

---

## `setPublicKeyExpiry`

Sets the time-to-live (TTL) for public keys in seconds. Useful when combined with key rotation to ensure old keys expire.

```ts
.setPublicKeyExpiry(8.64e+6) // 100 days
```

Example with rotation:

```ts
.setJwksRotatorOptions({
  intervalMs: 7.862e+9, // 91 days
  timestampStore: createInMemoryKeyStore()
})
.setPublicKeyExpiry(8.64e+6); // 100 days
```

---

## Token validation with `validate`

We previously saw Token Issuance with `tokenRoute`, now we will see Token validation with `validate`.

Example with Authorization Code Flow builder:

```ts
import { OAuth2AuthorizationCodeBuilder } from '@kaapi/oauth2-auth-design';

OAuth2AuthorizationCodeBuilder
  .create()
  .validate(async (request, { token }) => {
  
    const user = {  } || null // TODO Use the access token to look up the user

    if (!user) {
      return { isValid: false };
    }

    return {
      isValid: true,
      credentials: {
        user: {
          sub: user.id,
          name: user.name,
          given_name: user.given_name,
          email: user.email
        }
      }
    };
  })
  // configure additional settings
```

In the Kaapi app, `credentials` will be available in your controller under `request.auth.credentials`.

```ts
// @kaapi/kaapi app
app.route(
    {
        method: 'GET',
        path: '/',
        auth: true
    },
    (request) => `Hello ${request.auth.credentials.user.name}`
);
```

---

## JWT access token

Enables verification of access tokens using the JWKS public keys with `useAccessTokenJwks`.

Example with OIDC Authorization Code Flow builder:

```ts
import { OIDCAuthorizationCodeBuilder } from '@kaapi/oauth2-auth-design';

OIDCAuthorizationCodeBuilder
  .create()
  .setTokenTTL(3600)
  .useAccessTokenJwks(true)
  .tokenRoute(route =>
    route.generateToken(async ({ createIdToken, createJwtAccessToken, tokenType, ttl }, request) => {
      const { token: accessToken } = await createJwtAccessToken({
        /* JWT payload */
      });

      const { token: idToken } = await createIdToken({
        /* JWT payload */
      });

  
      // Example success
      return new OAuth2TokenResponse({ access_token: accessToken })
          .setExpiresIn(ttl)
          .setTokenType(tokenType)
          .set
    })
  )
  .validate(async (request, { jwtAccessTokenPayload, token }) => {
    // custom validation logic
  });
```
From the example:
In the token issuance, the access token is created with `createJwtAccessToken` from a payload. JWT properties will already be set like `exp` will use the value set in `setTokenTTL` (which is `ttl` also used in the response for at `setExpiresIn`) but it can still be overwritten in the payload you set.
`createIdToken` is used to create id token. As `createJwtAccessToken`, it signs the payload with the private key of JWKS. So it can be verified using the public keys.
In `validate`, `jwtAccessTokenPayload` is the verified payload from the JWT access token. `token` is the JWT string. 

---

## ðŸ“Œ Summary

<!-- Summary by points -->

---
